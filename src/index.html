<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- jQuery + Underscore + Backbone -->
<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<!-- Underscore -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore.js"></script>

<!-- Backbone -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone.js"></script>

<!-- Firebase -->
<script src="https://cdn.firebase.com/js/client/2.0.3/firebase.js"></script>

<!-- BackboneFire -->
<script src="https://cdn.firebase.com/libs/backbonefire/0.5.1/backbonefire.js"></script>

<script src="//d3js.org/d3.v3.min.js"></script>
<script src="js/bootstrap.min.js"></script>


<!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">

<style>
	.food-container {
		width: 100%;
		order: 1;
		display: flex;
		flex-box: box;
	}
	.day-button {
		margin: 0.1em;
	}
	/*
	#days {
		display: flex;
		flex-wrap: wrap;
	}
	
	.meals {
		display: flex;
		flex-wrap: wrap;
	}
	.meal-container {
		width: 100%;
		display: flex;
		flex-wrap: wrap;
		margin: 1em;
	}
	
	.calorie-total {
		order: 0;
	}*/
</style>

<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  position: relative;
  width: 960px;
}

text {
  font: 10px sans-serif;
}

.axis path {
  display: none;
}

.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.group-label {
  font-weight: bold;
  text-anchor: end;
}

form {
  //position: absolute;
  right: 10px;
  top: 10px;
}

</style>



</head>
<body>
	<section id="d3-graph">
		<form>
			<label><input type="radio" name="mode" value="multiples" checked> Multiples</label>
			<label><input type="radio" name="mode" value="stacked"> Stacked</label>
		</form>
	</section>
	<header id="search">
		<h1>I ate...</h1>
		<input id="search-food" placeholder="What did I eat?">
		<button class="search-food-button">Search</button>
	</header>
	
	<section id="nutritionix-list"></section>
	
	<section id="addFood">
		<input class="food-input" type="text" value="food">
		<input class="meal-input" type="text" placeholder="meal">
		<input class="date-input" type="text" placeholder="date">
		<input class="quantity-input" type="text" placeholder="quantity">
		<input class="units-input" type="text" placeholder="units">
		<input class="calories-input" type="text" placeholder="calories">
		<button class="addFood-button">Add Food</button>
	</section>
	
	<section id="days" class="container"></section>
	
	
	
	<section id="meals"></section>
	<script id="foodTemplate" type="text/template">
		<div><%= name %></div>
		<div><%= meal %></div>
		<div><%= date %></div>
		<div><%= quantity %></div>
		<div><%= units %></div>
		<div><%= calories %></div>
	</script>
	
	<script id="nutritionixFoodTemplate" type="text/template">
		<div><%= name %></div>
		<div class="nutid"><%= nutritionixId %></div>
		<div><%= quantity %></div>
		<div><%= units %></div>
		<div><%= calories %></div>
	</script>
	
	<script>
		//var searchString = '';
		var self = this;
		
		/*from codebeerstartups*/
		var template = function(id){
			return _.template( $('#' + id).html() );
		};
		
		// This is a plain old Backbone Model
		var FoodItem = Backbone.Model.extend({
			
		  defaults: {
			name: 'food',
			meal: 'snack',
			quantity: 1,
			date: 20151211,
			units: 'whole',
			calories: 1
		  }
		});
		
		var NutritionixFoodItem = Backbone.Model.extend({
			defaults: {
				name: '',
				nutritionixId: 0,
				quantity: 0,
				units: 'NA',
				calories: 0
			}
		});
		
		
		var FoodCollection = Backbone.Firebase.Collection.extend({
			model: FoodItem,
			comparator: 'date',
			url: 'https://glaring-torch-4473.firebaseio.com/calorieapp/flat/',
		});
		
		var NutritionixFoodList = Backbone.Collection.extend({
			model: NutritionixFoodItem
		});
	
		var FoodView = Backbone.View.extend({
			tagName: 'div',
			attributes: {
				'class': 'food-container'
			},
			
			template: template('foodTemplate'),
			initialize: function(){
				this.render();
			},

			render: function(){
				this.$el.html( this.template(this.model.toJSON()));
				return this;
			}
		});
		
		//for testing/debugginng
		var FoodCollectionView = Backbone.View.extend({
			tagName: 'div',
			attributes: {
				'class': 'foodList-container'
			},
			
			initialize: function(){
				this.collection.on('add', this.addOne, this);
			},
			
			render: function(){
				this.collection.each(function(food){
					//var foodView = new FoodView({ model: food });
					//this.$el.append(foodView.el); // adding all the person objects.
					this.addOne(food);
				}, this);
				return this;
			},
			
			addOne: function(food) {
				var foodView = new FoodView({ model: food });
				this.$el.append(foodView.el); // adding all the food objects.
			}
		});
		
		
		//MealView will make a meal div and take an array of food models and make food views for each
		//It will listen to collection changes/adds/deletes for meal and day info, update accordingly
		var MealView = Backbone.View.extend({
			tagName: 'div',
			list: [],
			collection: Object,
			date: String,
			meal: String,
			calories: Number,
			attributes: {
				'class': 'meal-container'
			},
			
			initialize: function(params){
				//console.log('params:');
				//console.dir(params);
				this.collection = params.collection;
				this.list = params.list;
				this.date=params.date;
				this.meal=params.meal;
				this.calories=0;
				this.$el.append('<div class="meal-name">'+this.meal+'</div>');
				this.$el.append('<div class="calorie-total">'+this.calories+'</div>');
				//console.dir(this.$el.css);
				
				this.collection.on('add', this.conditionalAddOne, this);
			},
			
			render: function(){
				//console.dir(this.list);
				
				this.list.forEach(function(food){
					//var foodView = new FoodView({ model: food });
					//this.$el.append(foodView.el); // adding all the person objects.
					this.addOne(food);
				}, this);
				
				return this;
			},
			
			conditionalAddOne: function(food) {
				//console.log('in conditionalAddOne: '+this.date+' '+this.meal);
				//console.dir(food);
				if(food.get('date') == this.date && food.get('meal') == this.meal) {
					//console.log('adding food to meal');
					this.list.push(food)
					this.addOne(food);
				}
			},
			
			addOne: function(food) {
				//console.log('meal adding food');
				//console.dir(food);
				//console.dir(this.$('.calorie-total'));
				var foodView = new FoodView({ model: food });
				this.$el.append(foodView.el); // adding all the person objects.
				this.calories += parseInt(food.get('calories'));
				this.$('.calorie-total')[0].innerHTML=this.calories;
				//this.$el.
			}
		});
		
		//DayView will make a day div and take an array of meals and make a mealview for each
		//It will listen to collection changes/adds/deletes for meal and day info, update accordingly
		var DateView = Backbone.View.extend({
			tagName: 'div',
			day: String,
			calories: Number,
			collection: Object,
			attributes: {
				'class': 'day-container'
			},
			initialize: function(params){
				this.collection = params.collection;
				this.day = params.day;
				this.calories = parseInt(params.firstCalories);
				
				this.$el.append('<button type="button" class="day-button btn btn-block row" data-toggle="collapse" data-target="#meals-for-'+this.day+'"><div class="col-xs-3">'+this.day+'</div> - <div class="col-xs-3 calorie-total"'+this.calories+'</div></button>');
				//this.$el.append('<div class="calorie-total">'+this.calories+'</div>');
				this.$el.append('<div class="meals collapse" id="meals-for-'+this.day+'"></div>');
				this.$el.css({'order':(parseInt(this.day)-20150000) * -1});
				this.collection.on('add', this.conditionalUpdateCalories, this);
				//console.dir(this);
			},
			render: function(){
				return this;
			},
			conditionalUpdateCalories: function(food){
				if(food.get('date') == this.day) {
					this.updateCalories(food);
				}
			
			},
			updateCalories: function(food) {
				this.calories += parseInt(food.get('calories'));
				this.$('.calorie-total')[0].innerHTML=this.calories;
				
			}
		});
		
		
		var SearchView = Backbone.View.extend({
			el: '#search',
			searchString: String,
			events: {
				'click .search-food-button': 'search'
			},
			search: function(e) {
				console.log('searching...');
				//console.dir(e);
				var searchBase = 'https://api.nutritionix.com/v1_1/search/';
				var searchParams = '?results=0:3&fields=item_name,brand_name,item_id,nf_calories&';
				var nAppId = 'f4a802c3';
				var nAppKey = 'bf99750cd2a7430e09cc6922ab659d72';
				searchString = $('#search-food').val().trim();
				//var nc = self.nutController;
				//console.dir(nc);
				var searchUrl = searchBase+searchString+searchParams+'appId='+nAppId+'&appKey='+nAppKey;
				console.log(searchUrl);
				$.ajax({
					  // The 'type' property sets the HTTP method.
					  // A value of 'PUT' or 'DELETE' will trigger a preflight request.
					  type: 'GET',

					  // The URL to make the request to.
					  url: searchUrl,

					  // The 'contentType' property sets the 'Content-Type' header.
					  // The JQuery default for this property is
					  // 'application/x-www-form-urlencoded; charset=UTF-8', which does not trigger
					  // a preflight. If you set this value to anything other than
					  // application/x-www-form-urlencoded, multipart/form-data, or text/plain,
					  // you will trigger a preflight request.
					  contentType: 'text/plain',
					  
					  success: function(result) {
						//console.dir(result.hits[0].fields);
						//var item1 = new app.FoodItem({name: 'tortellini',meal: 'Dinner', quantity: 8, units: 'oz', calories: 400, notes: 'I ate dinner'});
						//var nutListView = new NutritionixListView({data: result});
						console.log('got a result...');
						console.dir(result);
						self.calorieViewController.buildNutListView({data:result});
						/*
						for (var i=0,l=result.hits.length;i<l;i++) {
							var fields = result.hits[i].fields;
							var item = new app.NutritionixFoodItem({name: fields['item_name'],quantity: fields['nf_serving_size_qty'],units: fields['nf_serving_size_unit'],calories: fields['nf_calories'], nutritionixId: fields['item_id']});
							var view = new app.NutritionixFoodItemView({model: item});
							_this.$el.append(view.render().el);
							//searchResults.push(item)
						}
						
						*/
						//_this.renderSearch()
					  },
					  
					  error: function(e) {
						console.dir(e);
					  }
				});
			}
		});
		
		
		var NutritionixListView = Backbone.View.extend({
			tagName: 'ul',
			collection: Object,
			initialize: function(params) {
				this.collection = params.collection;
				//this.render();
			},
			render: function() {
				this.collection.each(function(nutFood){
					//var foodView = new FoodView({ model: food });
					//this.$el.append(foodView.el); // adding all the person objects.
					this.addOne(nutFood);
				}, this);
				return this;
			},
			addOne: function(nutFood) {
				var nutFoodView = new NutritionixFoodView({ model: nutFood });
				this.$el.append(nutFoodView.el); // adding all the food objects.
			}
		});
		
		var NutritionixFoodView = Backbone.View.extend({
			tagName: 'li',
			events: {
				'click .nutid': 'pickNutritionixItem'
			},
			template: template('nutritionixFoodTemplate'),
			initialize: function(){
				this.render();
			},

			render: function(){
				this.$el.html( this.template(this.model.toJSON()));
				return this;
			},
			pickNutritionixItem: function(){
				self.calorieViewController.populateAddFood(this.model);
			}
		});
		
		/*var FoodView = Backbone.View.extend({
			tagName: 'div',
			attributes: {
				'class': 'food-container'
			},
			
			template: template('foodTemplate'),
			initialize: function(){
				this.render();
			},

			render: function(){
				this.$el.html( this.template(this.model.toJSON()));
				return this;
			}
		});
		*/
		
		var AddFoodView = Backbone.View.extend({
			el: '#addFood',  // referencing the form itself.
			
			events: {
				'click .addFood-button': 'submit'  // binding submit click to submit function..
			},
			
			submit: function(e){
				console.log('submitting addfoodview');
				console.dir(e);
				//e.preventDefault();  // preventing default submission..
				var name = $('.food-input').val();  // getting new form values..
				var meal = $('.meal-input').val();  // getting new form values..
				var date = $('.date-input').val();  // getting new form values..
				var quantity = $('.quantity-input').val();  // getting new form values..
				var units = $('.units-input').val();  // getting new form values..
				var calories = $('.calories-input').val();  // getting new form values..
				//var person = new App.Models.Person({ name: newPersonName });// creating a new person object..
				this.collection.add({name: name, meal: meal, date: date, quantity: quantity, units: units, calories: calories}); // adding this to current collection..

			},
			populate: function(nutfood) {
				var d = new Date();
				var y = String(d.getFullYear());
				var m = String(d.getMonth()+1);
				var a = String(d.getDate());
				var date = y+m+a;
				
				$('.food-input').val(nutfood.get('name'));
				$('.meal-input').val('snack');
				$('.date-input').val(date);
				$('.quantity-input').val('1');
				$('.units-input').val(nutfood.get('units'));
				$('.calories-input').val(nutfood.get('calories'));
			
			}
		});
		
		/*
		var NutritionixViewController = function() {
			this.searchView = new SearchView();
			this.addFoodView = new AddFoodView({collection: collection});
			
			this.nutListView = null;
			this.nutritionixCollection = new NutritionixFoodList();
			
		};
		
		NutritionixViewController.prototype.buildNutListView = function(data) {
			console.log('empty nut collection?');
			console.dir(this.nutritionixCollection);
			var result=data.data;
			for (var i=0,l=result.hits.length;i<l;i++) {
				var fields = result.hits[i].fields;
				this.nutritionixCollection.add({name: fields['item_name'],quantity: fields['nf_serving_size_qty'],units: fields['nf_serving_size_unit'],calories: fields['nf_calories'], nutritionixId: fields['item_id']});
				//var item = new app.NutritionixFoodItem({name: fields['item_name'],quantity: fields['nf_serving_size_qty'],units: fields['nf_serving_size_unit'],calories: fields['nf_calories'], nutritionixId: fields['item_id']});
				//var view = new app.NutritionixFoodItemView({model: item});
				//_this.$el.append(view.render().el);
				
			}
			this.nutListView = new NutritionixListView({collection: this.nutritionixCollection});
			console.log('the nut list view');
			console.dir(this.nutListView);
			$('#nutritionix-list').append(this.nutListView.render().el);
		};
		
		NutritionixViewController.prototype.populateAddFood = function(nutfood) {
			console.log('the nutfood to use...');
			console.dir(nutfood);
			this.addFoodView.populate(nutfood);

		};
		*/
		var CalorieViewController = function(){
			var self = this;
			console.log('making calorieviewcontroller');
			console.dir(self);
			self.map = {};
			
			self.collection = new FoodCollection();
			
			self.collection.on('add', function(food){
				var datekey = food.get('date');
				var mealkey = food.get('meal');
				var firstCalories = food.get('calories');
				var dateView = null;
				if(!self.map[datekey]) {
					dateView = new DateView({collection: self.collection, day: datekey, firstCalories: firstCalories});
					$('#days').append(dateView.render().el);
					self.map[datekey] = {dateView: dateView};
				}
				else {
					dateView = self.map[datekey]['dateView'];
				}
				
				if(!self.map[datekey][mealkey]) {
					var mealView = new MealView({collection: self.collection, list: [food], date: datekey, meal: mealkey});
					//dateView.$el.find('.meals')[0].append(mealView.render().el);
					console.dir(dateView.$el.find('.meals'));
					var dateEl = dateView.$el.find('.meals');
					$(mealView.render().el).appendTo(dateEl);
					self.map[datekey][mealkey]=mealView;
				}
			});
			
			self.searchView = new SearchView();
			self.addFoodView = new AddFoodView({collection: self.collection});
			
			self.nutListView = null;
			self.nutritionixCollection = new NutritionixFoodList();
		};
		
		CalorieViewController.prototype.buildNutListView = function(data) {
			console.log('empty nut collection?');
			console.dir(this.nutritionixCollection);
			var result=data.data;
			for (var i=0,l=result.hits.length;i<l;i++) {
				var fields = result.hits[i].fields;
				this.nutritionixCollection.add({name: fields['item_name'],quantity: fields['nf_serving_size_qty'],units: fields['nf_serving_size_unit'],calories: fields['nf_calories'], nutritionixId: fields['item_id']});
				//var item = new app.NutritionixFoodItem({name: fields['item_name'],quantity: fields['nf_serving_size_qty'],units: fields['nf_serving_size_unit'],calories: fields['nf_calories'], nutritionixId: fields['item_id']});
				//var view = new app.NutritionixFoodItemView({model: item});
				//_this.$el.append(view.render().el);
				
			}
			this.nutListView = new NutritionixListView({collection: this.nutritionixCollection});
			console.log('the nut list view');
			console.dir(this.nutListView);
			$('#nutritionix-list').append(this.nutListView.render().el);
		};
		
		CalorieViewController.prototype.clearNutCollection = function() {
			this.nutritionixCollection.reset();
			//need to set the views to listen to reset event and clean themselves up
		};
		
		CalorieViewController.prototype.populateAddFood = function(nutfood) {
			console.log('the nutfood to use...');
			console.dir(nutfood);
			this.addFoodView.populate(nutfood);

		};
		
		self.calorieViewController = new CalorieViewController();
		//self.nutController = new NutritionixViewController();
		//var collection = new FoodCollection();
		//collection.on('all', function(event){
			//console.dir(event);
		//});
		
		//var addFoodView = new AddFoodView({collection: collection});
		
		//var foodCollectionView = new FoodCollectionView({ collection: collection });
		//$(document.body).append(foodCollectionView.render().el);
		
		/*
		var groups = collection.groupBy(function(model){return [model.get('date'), model.get('meal')];});
		var l = Object.keys(groups);
		l.forEach(function(f){
			//console.dir(groups[f]);
			var mealView = new MealView({collection: collection, list: groups[f], date: groups[f][0].get('date'), meal: groups[f][0].get('meal')}) 
			$(document.body).append(mealView.render().el);
		});
		*/
	</script>
	<script>
		var buildGroupedData = function() {
			groups = calorieViewController.collection.sortBy('meal');
			console.dir(groups);
			var mlist = [];
			var currentMeal = groups[0].get('meal');
			var currentDate = groups[0].get('date');
			var currentCals = 0;
			
			groups.forEach(function(item,i){
				console.log(currentMeal + ' - '+currentDate);
				if(item.get('meal') == currentMeal && item.get('date') == currentDate) {
					currentCals += parseFloat(item.get('calories'));
				}
				else {
					var mm = {meal: currentMeal, date: currentDate, cals: currentCals};
					console.log('adding a meal: ');
					console.dir(mm);
					mlist.push(mm);
					console.dir(mlist);
					currentMeal = item.get('meal');
					currentDate = item.get('date');
					currentCals = parseFloat(item.get('calories'));
				}
				if(groups.length == i+1) {
					mlist.push({meal: currentMeal, date: currentDate, cals: currentCals});
				}
				console.dir(mlist);
			});
			return mlist;
		};
	</script>
	
	
	<script>
var buildD3 = function(){


//var parseDate = d3.time.format("%Y-%m").parse,
//    formatYear = d3.format("02d"),
    //formatDate = function(d) { return "Q" + ((d.getMonth() / 3 | 0) + 1) + formatYear(d.getFullYear() % 100); };

   // formatDate = function(d) { return String(d.getFullYear()%100)+String(d.getMonth()+1)+String(d.getDate());}

	
	var margin = {top: 10, right: 20, bottom: 20, left: 60},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var y0 = d3.scale.ordinal()
    .rangeRoundBands([height, 0], .2);

var y1 = d3.scale.linear();

var x = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1, 0);

var y = d3.scale.linear()
    .range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");
    //.tickFormat(formatDate);
	//.tickFormat(function(d) { return String(d.date); });@@@@@@@@@@@remove ; from .orient if put this back in
var yAxis = d3.svg.axis()
	.scale(y)
	.orient('right')
	.ticks(20, '');
	
var nest = d3.nest()
    //.key(function(d) { return d.group; });
	.key(function(d){ return d.meal;});

var stack = d3.layout.stack()
    .values(function(d) { return d.values; })
    .x(function(d) { return d.date; })
    //.y(function(d) { return d.value; })
	.y(function(d) {return d.cals;})
    .out(function(d, y0) { d.valueOffset = y0; });

var color = d3.scale.category10();

//var svg = d3.select("body").append("svg")
var svg = d3.select('#d3-graph').append('svg')
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

//d3.tsv("data.tsv", function(error, data) {
var data = buildGroupedData();
console.log('d3 got data: ');
console.dir(data);
  data.forEach(function(d) {
    //d.date = parseDate(d.date);
    //d.value = +d.value;
	d.cals = +d.cals;
  });

  var dataByGroup = nest.entries(data);
  console.log('dataByGroup:');
  console.dir(dataByGroup);

  stack(dataByGroup);
  x.domain(dataByGroup[0].values.map(function(d) { return d.date; }));
  y.domain([0, d3.max(data, function(d) { return parseFloat(d.cals); })]);
  y0.domain(dataByGroup.map(function(d) { return d.key; }));
  //y1.domain([0, d3.max(data, function(d) { return d.value; })]).range([y0.rangeBand(), 0]);
  y1.domain([0, d3.max(data, function(d) {return d.cals;})]).range([y0.rangeBand(), 0]);

  var group = svg.selectAll(".group")
      .data(dataByGroup)
    .enter().append("g")
      .attr("class", "group")
      .attr("transform", function(d) { return "translate(0," + y0(d.key) + ")"; });

  group.append("text")
      .attr("class", "group-label")
      .attr("x", -6)
      //.attr("y", function(d) { return y1(d.values[0].value / 2); })
	  .attr('y', function(d) { return y1(d.values[0].cals / 2); })
      .attr("dy", ".35em")
      //.text(function(d) { return "Group " + d.key; });
	  .text(function(d) {return d.key;});

  group.selectAll("rect")
      .data(function(d) { return d.values; })
    .enter().append("rect")
      //.style("fill", function(d) { return color(d.group); })
	  .style('fill', function(d) { return color(d.meal); })
      .attr("x", function(d) { return x(d.date); })
      //.attr("y", function(d) { return y1(d.value); })
	  .attr('y', function(d) { return y1(d.cals); })
      .attr("width", x.rangeBand())
      //.attr("height", function(d) { return y0.rangeBand() - y1(d.value); });@@@@@@@@@@@@@@@@different
	  .attr('height', function(d) {return y0.rangeBand() - y1(d.cals); });

  group.filter(function(d, i) { return !i; }).append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + y0.rangeBand() + ")")
      .call(xAxis);
  
  group.append("g")
      .attr("class", "y axis")
      .call(yAxis);

  d3.selectAll("input").on("change", change);

//  var timeout = setTimeout(function() {
//    d3.select("input[value=\"stacked\"]").property("checked", true).each(change);
//  }, 2000);

  function change() {
    //clearTimeout(timeout);
    if (this.value === "multiples") transitionMultiples();
    else transitionStacked();
  }

  function transitionMultiples() {
    var t = svg.transition().duration(750),
        g = t.selectAll(".group").attr("transform", function(d) { return "translate(0," + y0(d.key) + ")"; });
    //g.selectAll("rect").attr("y", function(d) { return y1(d.value); });
	g.selectAll('rect').attr('y', function(d) { return y1(d.cals); });
    //g.select(".group-label").attr("y", function(d) { return y1(d.values[0].value / 2); })
	g.select('.group-label').attr('y', function(d) { return y1(d.values[0].cals / 2); })
  }

  function transitionStacked() {
    var t = svg.transition().duration(750),
        g = t.selectAll(".group").attr("transform", "translate(0," + y0(y0.domain()[0]) + ")");
    //g.selectAll("rect").attr("y", function(d) { return y1(d.value + d.valueOffset); });
	g.selectAll("rect").attr("y", function(d) { return y1(d.cals + d.valueOffset); });
    //g.select(".group-label").attr("y", function(d) { return y1(d.values[0].value / 2 + d.values[0].valueOffset); })
	g.select(".group-label").attr("y", function(d) { return y1(d.values[0].cals / 2 + d.values[0].valueOffset); })
  }
};
//}
</script>


</body>
</html>